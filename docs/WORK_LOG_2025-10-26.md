# ì‘ì—… ì§„ë„ ê¸°ë¡ - 2025-10-26

## ğŸ“‹ ì‘ì—… ê°œìš”
- **ì‘ì—…ì¼**: 2025ë…„ 10ì›” 26ì¼
- **ì‘ì—…ì**: DevOps Team
- **ì£¼ìš” ëª©í‘œ**: Cloud Run Job ìë™ ì‹¤í–‰ ë¬¸ì œ í•´ê²° ë° Datadog í†µí•© ì¤€ë¹„

---

## ğŸ¯ ì£¼ìš” ì„±ê³¼

### 1. Cloud Run Job ìë™ ì‹¤í–‰ ë¬¸ì œ í•´ê²° âœ…

#### ë¬¸ì œ ìƒí™©
- Cloud Run v2 Jobì´ Cloud Schedulerì—ì„œ HTTP ì§ì ‘ í˜¸ì¶œ ì‹œ **401 UNAUTHENTICATED** ì˜¤ë¥˜ ë°œìƒ
- ì›ì¸: Cloud Run v2 APIì˜ OIDC í† í° ì¸ì¦ ë°©ì‹ í˜¸í™˜ ë¬¸ì œ
- ì˜í–¥: 10ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰ë˜ì–´ì•¼ í•  ë¡œê·¸ ìƒì„± Jobì´ ì‘ë™í•˜ì§€ ì•ŠìŒ

#### í•´ê²° ê³¼ì •

**ì‹œë„ 1: API ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •**
- v1 API â†’ v2 API ì—”ë“œí¬ì¸íŠ¸ ë³€ê²½ ì‹œë„
- ê²°ê³¼: ì—¬ì „íˆ 401 ì˜¤ë¥˜ ë°œìƒ

**ì‹œë„ 2: Project Number ì‚¬ìš©**
- Project ID ëŒ€ì‹  Project Number ì‚¬ìš©
- URL: `namespaces/{project_number}/jobs/{job_name}:run`
- ê²°ê³¼: 401 ì˜¤ë¥˜ ì§€ì†

**ì‹œë„ 3: IAM ê¶Œí•œ ì¶”ê°€**
- `roles/run.developer` ê¶Œí•œ ì¶”ê°€
- ê²°ê³¼: ì¸ì¦ ë¬¸ì œ í•´ê²°ë˜ì§€ ì•ŠìŒ

**ìµœì¢… í•´ê²°: Pub/Sub ê¸°ë°˜ ì´ë²¤íŠ¸ ì•„í‚¤í…ì²˜ë¡œ ë³€ê²½** âœ…
- Cloud Scheduler â†’ Pub/Sub Topic â†’ Pub/Sub Subscription â†’ Cloud Run Job
- ì•ˆì •ì ì¸ ì´ë²¤íŠ¸ ê¸°ë°˜ íŠ¸ë¦¬ê±°ë§
- ì¸ì¦ ë¬¸ì œ ì™„ì „ í•´ê²°

#### êµ¬í˜„ ìƒì„¸

**1. Pub/Sub ë¦¬ì†ŒìŠ¤ ì¶”ê°€**
```hcl
# Pub/Sub Topic
resource "google_pubsub_topic" "log_generator_trigger" {
  name = "log-generator-trigger-dev"
}

# Pub/Sub Subscription (Push ë°©ì‹)
resource "google_pubsub_subscription" "log_generator_subscription" {
  name  = "log-generator-subscription-dev"
  topic = google_pubsub_topic.log_generator_trigger.name

  push_config {
    push_endpoint = "https://${var.gcp_region}-run.googleapis.com/apis/run.googleapis.com/v1/namespaces/${var.gcp_project_number}/jobs/${var.job_name}:run"

    oidc_token {
      service_account_email = google_service_account.job_runner_sa.email
    }
  }
}
```

**2. Service Account ì¶”ê°€**
- `scheduler-pubsub-publisher`: Pub/Sub ë©”ì‹œì§€ ë°œí–‰ ì „ìš©
- `log-generator-job-runner`: Cloud Run Job ì‹¤í–‰ ì „ìš©

**3. Cloud Scheduler íƒ€ê²Ÿ ë³€ê²½**
```hcl
resource "google_cloud_scheduler_job" "run_log_generator" {
  pubsub_target {
    topic_name = google_pubsub_topic.log_generator_trigger.id
    data       = base64encode("{\"trigger\":\"scheduled\"}")
  }
}
```

#### ê²°ê³¼
- âœ… 10:40 ì²« ìë™ ì‹¤í–‰ ì„±ê³µ (`log-generator-job-h8jl4`)
- âœ… 10ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰ ì¤‘
- âœ… ë¡œê·¸ 100ê°œ ì •ìƒ ìƒì„± (access, business, security)

---

### 2. Datadog í†µí•© ì¤€ë¹„ ì™„ë£Œ âœ…

#### ì‘ì—… ë‚´ìš©

**1. Datadog í†µí•© ê°€ì´ë“œ ë¬¸ì„œ ì‘ì„±**
- íŒŒì¼: [docs/DATADOG_INTEGRATION.md](DATADOG_INTEGRATION.md)
- ë‚´ìš©:
  - GCP êµ¬ë…í˜• Datadog ì„¤ì • ë°©ë²•
  - Log Forwarder ë°°í¬ ê°€ì´ë“œ (Pub/Sub â†’ Cloud Function â†’ Datadog)
  - Service Account ë° ê¶Œí•œ ì„¤ì •
  - Log Sink ìƒì„± ë° í•„í„°ë§
  - Log Pipeline, Dashboard, Monitor ì„¤ì •
  - ë¡œê·¸ ìŠ¤í‚¤ë§ˆ ë° Facet ì„¤ì •
  - íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê°€ì´ë“œ

**2. Datadog API Key í™˜ê²½ ë³€ìˆ˜ ì£¼ì…**

**Terraform ìˆ˜ì •:**
```hcl
# variables.tf
variable "datadog_api_key" {
  description = "Datadog API Key for sending logs"
  type        = string
  sensitive   = true
  default     = ""
}

# main.tf
resource "google_cloud_run_v2_job" "log_generator_job" {
  template {
    template {
      containers {
        image = var.image_url

        env {
          name  = "DD_API_KEY"
          value = var.datadog_api_key
        }

        env {
          name  = "DD_SITE"
          value = "us5.datadoghq.com"
        }
      }
    }
  }
}
```

**GitHub Actions ìˆ˜ì •:**
```yaml
- name: Terraform Apply with Dynamic Image URL
  working-directory: terraform/gcp
  env:
    TF_VAR_datadog_api_key: ${{ secrets.DD_API_KEY }}
  run: |
    terraform apply -auto-approve -var="image_url=${IMAGE_URL}"
```

**GitHub Secret ì„¤ì •:**
- Secret Name: `DD_API_KEY`
- Secret Value: `<YOUR_DATADOG_API_KEY>`

#### ê²°ê³¼
- âœ… Cloud Run Jobì— Datadog API Key í™˜ê²½ ë³€ìˆ˜ ì„±ê³µì ìœ¼ë¡œ ì£¼ì…
- âœ… ë™ë£Œê°€ Datadog ì—°ë™ ì‘ì—… ì§„í–‰ ê°€ëŠ¥

---

## ğŸ”§ ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­

### ì•„í‚¤í…ì²˜ ë³€ê²½

**ë³€ê²½ ì „:**
```
Cloud Scheduler â†’ HTTP ì§ì ‘ í˜¸ì¶œ â†’ Cloud Run Job (âŒ 401 ì‹¤íŒ¨)
```

**ë³€ê²½ í›„:**
```
Cloud Scheduler (10ë¶„ë§ˆë‹¤)
  â†“
Pub/Sub Topic (log-generator-trigger-dev)
  â†“
Pub/Sub Subscription (log-generator-subscription-dev)
  â†“
Cloud Run Job (log-generator-job)
  â†“
Cloud Logging (ë¡œê·¸ 100ê°œ ìƒì„±)
```

### ê¶Œí•œ êµ¬ì„±

| Service Account | ì—­í•  | ê¶Œí•œ |
|----------------|------|------|
| `github-action-deployer` | CI/CD ë°°í¬ | `roles/pubsub.admin` ì¶”ê°€ |
| `scheduler-pubsub-publisher` | Scheduler ë©”ì‹œì§€ ë°œí–‰ | `roles/pubsub.publisher` |
| `log-generator-job-runner` | Job ì‹¤í–‰ | `roles/run.invoker` |

### ìƒì„±ëœ GCP ë¦¬ì†ŒìŠ¤

| ë¦¬ì†ŒìŠ¤ íƒ€ì… | ì´ë¦„ | ìš©ë„ |
|------------|------|------|
| Pub/Sub Topic | `log-generator-trigger-dev` | ìŠ¤ì¼€ì¤„ëŸ¬ ë©”ì‹œì§€ ìˆ˜ì‹  |
| Pub/Sub Subscription | `log-generator-subscription-dev` | Cloud Run Job íŠ¸ë¦¬ê±° |
| Service Account | `scheduler-pubsub-publisher` | Pub/Sub ë°œí–‰ |
| Service Account | `log-generator-job-runner` | Job ì‹¤í–‰ |

---

## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼

### Cloud Run Job ì‹¤í–‰ ê¸°ë¡

```
JOB                EXECUTION                CREATED                  RUN BY
âœ”  log-generator-job  log-generator-job-67tk4  2025-10-26 10:42:41 UTC  log-generator-job-runner@...
âœ”  log-generator-job  log-generator-job-h8jl4  2025-10-26 10:40:01 UTC  log-generator-job-runner@...
âœ”  log-generator-job  log-generator-job-jdk8q  2025-10-26 09:58:04 UTC  lowshot31@gmail.com
```

### ìƒì„±ëœ ë¡œê·¸ ìƒ˜í”Œ

**Security ë¡œê·¸:**
```json
{
  "timestamp": "2025-10-26T10:41:14.320872Z",
  "level": "ERROR",
  "service": "auth-service",
  "event_type": "suspicious_activity",
  "message": "Security event detected: South picture.",
  "details": {
    "attempt_count": 6,
    "reason": "brute_force_attempt",
    "source_ip": "126.89.81.192",
    "user_id": "coreygregory"
  }
}
```

**Business ë¡œê·¸:**
```json
{
  "timestamp": "2025-10-26T10:41:14.319533Z",
  "level": "CRITICAL",
  "service": "order-service",
  "event_type": "order_processed",
  "message": "New order #70595185 processed",
  "details": {
    "transaction_id": "911dee3a-b6d0-44cf-b7f9-0fd593440335",
    "user_id": "user-3688",
    "total_amount": 415.03,
    "currency": "KRW",
    "payment_method": "credit_card"
  }
}
```

**Access ë¡œê·¸:**
```json
{
  "timestamp": "2025-10-26T10:41:14.320748Z",
  "level": "INFO",
  "service": "product-service",
  "event_type": "api_call",
  "message": "Request to wp-content/categories completed",
  "details": {
    "request_id": "5a162a78-a0b4-4aec-a0eb-691da4073c3c",
    "http_method": "PUT",
    "status_code": 200,
    "response_time_ms": 624,
    "user_id": "user-2121"
  }
}
```

### Cloud Scheduler ìƒíƒœ

```yaml
name: run-log-generator-job-dev
schedule: '*/10 * * * *'
state: ENABLED
pubsubTarget:
  topicName: projects/main-ember-469911-e9/topics/log-generator-trigger-dev
  data: eyJ0cmlnZ2VyIjoic2NoZWR1bGVkIn0=  # {"trigger":"scheduled"}
timeZone: UTC
```

### í™˜ê²½ ë³€ìˆ˜ í™•ì¸

```json
"env": [
  {
    "name": "DD_API_KEY",
    "value": "<YOUR_DATADOG_API_KEY>"
  },
  {
    "name": "DD_SITE",
    "value": "us5.datadoghq.com"
  }
]
```

---

## ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê¸°ë¡

### ë¬¸ì œ 1: Terraform 403 ê¶Œí•œ ì˜¤ë¥˜

**ì¦ìƒ:**
```
Error: Error retrieving IAM policy for pubsub topic
googleapi: Error 403: User not authorized to perform this action
```

**ì›ì¸:**
- GitHub Actions Service Accountì— Pub/Sub ê¶Œí•œ ì—†ìŒ

**í•´ê²°:**
```bash
gcloud projects add-iam-policy-binding main-ember-469911-e9 \
  --member="serviceAccount:github-action-deployer@main-ember-469911-e9.iam.gserviceaccount.com" \
  --role="roles/pubsub.admin"
```

### ë¬¸ì œ 2: Schedulerê°€ HTTP íƒ€ê²Ÿ ìœ ì§€

**ì¦ìƒ:**
- Terraform apply í›„ì—ë„ Schedulerê°€ pubsub_target ëŒ€ì‹  http_target ì‚¬ìš©

**ì›ì¸:**
- Terraformì´ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚­ì œí•˜ì§€ ì•Šê³  ì—…ë°ì´íŠ¸ ì‹œë„

**í•´ê²°:**
```bash
# ê¸°ì¡´ Scheduler ìˆ˜ë™ ì‚­ì œ
gcloud scheduler jobs delete run-log-generator-job-dev \
  --location=us-central1 \
  --project=main-ember-469911-e9 \
  --quiet

# ë¹ˆ ì»¤ë°‹ìœ¼ë¡œ ì¬ë°°í¬ íŠ¸ë¦¬ê±°
git commit --allow-empty -m "trigger: Terraform apply"
git push origin main
```

---

## ğŸ“ˆ ì„±ê³¼ ì§€í‘œ

### ì‹œê°„ ì†Œìš”
- ë¬¸ì œ ì§„ë‹¨: 30ë¶„
- í•´ê²° ë°©ì•ˆ ì‹œë„ (HTTP/API ìˆ˜ì •): 1ì‹œê°„ 30ë¶„
- Pub/Sub ì•„í‚¤í…ì²˜ êµ¬í˜„: 1ì‹œê°„
- Datadog í†µí•© ì¤€ë¹„: 1ì‹œê°„
- ë¬¸ì„œí™”: 30ë¶„
- **ì´ ì†Œìš” ì‹œê°„: ì•½ 4ì‹œê°„ 30ë¶„**

### ë°°í¬ íšŸìˆ˜
- ì´ í‘¸ì‹œ: 8íšŒ
- GitHub Actions ì‹¤í–‰: 8íšŒ
- ì„±ê³µí•œ ë°°í¬: 7íšŒ
- ì‹¤íŒ¨í•œ ë°°í¬: 1íšŒ (ê¶Œí•œ ë¬¸ì œ)

### ì½”ë“œ ë³€ê²½
- ìˆ˜ì •ëœ íŒŒì¼: 5ê°œ
  - `terraform/gcp/main.tf`
  - `terraform/gcp/variables.tf`
  - `.github/workflows/main.yaml`
  - `README.md`
  - ìƒˆë¡œ ì‘ì„±: `docs/DATADOG_INTEGRATION.md`

---

## ğŸ”œ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ì§„í–‰ ê°€ëŠ¥
1. **log_generator.py ìˆ˜ì •**
   - `DD_API_KEY` í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©
   - Datadog Logs API ì§ì ‘ ì „ì†¡ êµ¬í˜„

2. **Datadog Log Forwarder ë°°í¬** (ì„ íƒ ì‚¬í•­)
   - Cloud Logging â†’ Pub/Sub â†’ Cloud Function â†’ Datadog
   - ë¡œê·¸ í•„í„°ë§ ë° ìƒ˜í”Œë§

### í–¥í›„ ê³„íš
1. **Snowflake ì—°ë™**
   - Datadog Log Archive â†’ Snowflake
   - ERROR ë ˆë²¨ ë¡œê·¸ ìë™ ì „ì†¡
   - Snowpipe êµ¬ì„±

2. **ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ**
   - Datadog Dashboard êµ¬ì¶•
   - ë¡œê·¸ ë ˆë²¨ë³„ íŠ¸ë Œë“œ
   - ì„œë¹„ìŠ¤ë³„ ì—ëŸ¬ìœ¨

3. **ì•Œë¦¼ ì„¤ì •**
   - ERROR ë¡œê·¸ ê¸‰ì¦ ì•Œë¦¼
   - ë³´ì•ˆ ì´ë²¤íŠ¸ ì•Œë¦¼ (Slack ì—°ë™)
   - Job ì‹¤í–‰ ì‹¤íŒ¨ ì•Œë¦¼

---

## ğŸ“š ì°¸ê³  ìë£Œ

### ë¬¸ì„œ
- [docs/DATADOG_INTEGRATION.md](DATADOG_INTEGRATION.md) - Datadog í†µí•© ê°€ì´ë“œ
- [README.md](../README.md) - í”„ë¡œì íŠ¸ ì „ì²´ ë¬¸ì„œ

### GCP ë¬¸ì„œ
- [Cloud Run v2 API](https://cloud.google.com/run/docs/reference/rest/v2)
- [Pub/Sub Push Subscriptions](https://cloud.google.com/pubsub/docs/push)
- [Cloud Scheduler](https://cloud.google.com/scheduler/docs)

### Datadog ë¬¸ì„œ
- [GCP Integration](https://docs.datadoghq.com/integrations/google_cloud_platform/)
- [Log Collection from GCP](https://docs.datadoghq.com/logs/guide/collect-google-cloud-logs-with-push/)
- [Logs API](https://docs.datadoghq.com/api/latest/logs/)

---

## ğŸ’¡ êµí›ˆ ë° ê°œì„  ì‚¬í•­

### ë°°ìš´ ì 
1. **Cloud Run v2 APIì˜ ì¸ì¦ ë°©ì‹**
   - HTTP ì§ì ‘ í˜¸ì¶œë³´ë‹¤ Pub/Sub ê¸°ë°˜ì´ ì•ˆì •ì 
   - OIDC í† í° ì¸ì¦ì€ v2 APIì—ì„œ ì œí•œì 

2. **Pub/Subì˜ ì¥ì **
   - ì¬ì‹œë„ ìë™ ì²˜ë¦¬
   - í™•ì¥ ê°€ëŠ¥í•œ ì•„í‚¤í…ì²˜
   - ì—¬ëŸ¬ êµ¬ë…ì ì¶”ê°€ ìš©ì´

3. **Terraform ë¦¬ì†ŒìŠ¤ êµì²´**
   - Target íƒ€ì… ë³€ê²½ ì‹œ ìˆ˜ë™ ì‚­ì œ í•„ìš”
   - `terraform taint` ë˜ëŠ” `replace` ê³ ë ¤

### ê°œì„  ê°€ëŠ¥í•œ ì 
1. **ë°°í¬ ì‹œê°„ ë‹¨ì¶•**
   - í˜„ì¬: 5ë¶„ ëŒ€ê¸° í•„ìš”
   - ê°œì„ : Cloud Build ìƒíƒœ í™•ì¸ API í™œìš©

2. **ëª¨ë‹ˆí„°ë§ ê°•í™”**
   - Cloud Run Job ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
   - Pub/Sub Dead Letter Queue ì„¤ì •

3. **ë¬¸ì„œ ìë™í™”**
   - Terraform ë¬¸ì„œ ìë™ ìƒì„±
   - API ë¬¸ì„œ ìë™í™”

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] Cloud Run Job ìë™ ì‹¤í–‰ ë¬¸ì œ í•´ê²°
- [x] Pub/Sub ê¸°ë°˜ ì•„í‚¤í…ì²˜ êµ¬í˜„
- [x] Datadog API Key í™˜ê²½ ë³€ìˆ˜ ì£¼ì…
- [x] Datadog í†µí•© ê°€ì´ë“œ ë¬¸ì„œ ì‘ì„±
- [x] README ì—…ë°ì´íŠ¸
- [x] ì‘ì—… ì§„ë„ ê¸°ë¡ ë¬¸ì„œ ì‘ì„±
- [ ] log_generator.py Datadog ì—°ë™ êµ¬í˜„ (ë™ë£Œ ì‘ì—…)
- [ ] Datadog Dashboard êµ¬ì¶• (ë™ë£Œ ì‘ì—…)
- [ ] Snowflake ì—°ë™ (í–¥í›„ ê³„íš)

---

**ì‘ì„±ì¼**: 2025-10-26
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-26 19:15 KST
**ì‘ì„±ì**: DevOps Team
